#!/bin/bash
# Pre-push git hook
# Runs comprehensive quality and test checks before allowing push

set -e

echo ""
echo "╔════════════════════════════════════════╗"
echo "║       Running Pre-Push Quality Tests      ║"
echo "╚════════════════════════════════════════╝"
echo ""

# Color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Check 1: Full quality suite
echo -e "${YELLOW}[1/3] Running comprehensive quality checks...${NC}"
echo -e "${BLUE}  └─ Spotless, Checkstyle, SpotBugs${NC}"
if ./gradlew clean check spotlessCheck spotbugsMain --no-daemon --quiet 2>/dev/null; then
    echo -e "${GREEN}✓ All quality checks passed${NC}"
else
    echo -e "${RED}✗ Quality checks failed!${NC}"
    echo ""
    echo "Review the following reports:"
    echo "  - Checkstyle: build/reports/checkstyle/main.html"
    echo "  - SpotBugs: build/reports/spotbugs/main.html"
    echo ""
    echo "Please fix the issues before pushing."
    echo ""
    exit 1
fi

echo ""

# Check 2: Run tests
echo -e "${YELLOW}[2/3] Running test suite...${NC}"
if ./gradlew test --no-daemon --quiet 2>/dev/null; then
    echo -e "${GREEN}✓ All tests passed${NC}"
else
    echo -e "${RED}✗ Tests failed!${NC}"
    echo ""
    echo "Review: build/reports/tests/test/index.html"
    echo "Please fix failing tests before pushing."
    echo ""
    exit 1
fi

echo ""

# Check 3: Build verification
echo -e "${YELLOW}[3/3] Verifying build...${NC}"
if ./gradlew build --no-daemon --quiet 2>/dev/null; then
    echo -e "${GREEN}✓ Build successful${NC}"
else
    echo -e "${RED}✗ Build failed!${NC}"
    echo ""
    echo "Please fix build errors before pushing."
    echo ""
    exit 1
fi

echo ""
echo "╔════════════════════════════════════════╗"
echo "║  ✓ All checks passed! Ready to push!   ║"
echo "╚════════════════════════════════════════╝"
echo ""

exit 0
